---
sidebar: sidebar 
permalink: task-managing-svms-aws.html 
keywords: storage virtual machine, vserver, svm, storage vm, supported number, number supported 
summary: Une machine virtuelle de stockage est une machine virtuelle exécutée dans ONTAP qui fournit des services de stockage et de données à vos clients.  Vous connaissez peut-être cela sous le nom de SVM ou de vserver.  Cloud Volumes ONTAP est configuré avec une machine virtuelle de stockage par défaut, mais certaines configurations prennent en charge des machines virtuelles de stockage supplémentaires. 
---
= Gérer les machines virtuelles de stockage de données pour Cloud Volumes ONTAP dans AWS
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
Une machine virtuelle de stockage est une machine virtuelle exécutée dans ONTAP qui fournit des services de stockage et de données à vos clients.  Vous connaissez peut-être cela sous le nom de _SVM_ ou _vserver_.  Cloud Volumes ONTAP est configuré avec une machine virtuelle de stockage par défaut, mais certaines configurations prennent en charge des machines virtuelles de stockage supplémentaires.

Pour créer des machines virtuelles de stockage de service de données supplémentaires, vous devez allouer des adresses IP dans AWS, puis exécuter des commandes ONTAP en fonction de votre configuration Cloud Volumes ONTAP .



== Nombre de machines virtuelles de stockage prises en charge

Plusieurs machines virtuelles de stockage sont prises en charge avec des configurations Cloud Volumes ONTAP spécifiques à partir de la version 9.7.  Aller à la https://docs.netapp.com/us-en/cloud-volumes-ontap-relnotes/index.html["Notes de version de Cloud Volumes ONTAP"^] pour vérifier le nombre de machines virtuelles de stockage prises en charge pour votre version de Cloud Volumes ONTAP.

Toutes les autres configurations Cloud Volumes ONTAP prennent en charge une machine virtuelle de stockage de service de données et une machine virtuelle de stockage de destination utilisée pour la reprise après sinistre.  Vous pouvez activer la machine virtuelle de stockage de destination pour l'accès aux données en cas de panne sur la machine virtuelle de stockage source.



== Vérifiez les limites de votre configuration

Chaque instance EC2 prend en charge un nombre maximal d'adresses IPv4 privées par interface réseau.  Vous devez vérifier la limite avant d’allouer des adresses IP dans AWS pour la nouvelle machine virtuelle de stockage.

.Étapes
. Allez le https://docs.netapp.com/us-en/cloud-volumes-ontap-relnotes/reference-limits-aws.html["Section Limites de stockage dans les notes de publication de Cloud Volumes ONTAP"^] .
. Identifiez le nombre maximal d’adresses IP par interface pour votre type d’instance.
. Notez ce numéro car vous en aurez besoin dans la section suivante lorsque vous allouerez des adresses IP dans AWS.




== Attribuer des adresses IP dans AWS

Les adresses IPv4 privées doivent être attribuées au port e0a dans AWS avant de créer des LIF pour la nouvelle machine virtuelle de stockage.

Notez qu'un LIF de gestion facultatif pour une machine virtuelle de stockage nécessite une adresse IP privée sur un système à nœud unique et sur une paire HA dans une seule zone de disponibilité.  Ce LIF de gestion fournit une connexion à des outils de gestion comme SnapCenter.

.Étapes
. Connectez-vous à AWS et ouvrez le service EC2.
. Sélectionnez l’instance Cloud Volumes ONTAP et cliquez sur *Réseau*.
+
Si vous créez une machine virtuelle de stockage sur une paire HA, sélectionnez le nœud 1.

. Faites défiler jusqu'à *Interfaces réseau* et cliquez sur l'*ID d'interface* pour le port e0a.
+
image:screenshot_aws_e0a.gif["Une capture d’écran de la console AWS qui montre le port e0a sur une interface réseau."]

. Sélectionnez l'interface réseau et cliquez sur *Actions > Gérer les adresses IP*.
. Développez la liste des adresses IP pour e0a.
. Vérifiez les adresses IP :
+
.. Comptez le nombre d'adresses IP allouées pour confirmer que le port dispose de suffisamment d'espace pour des adresses IP supplémentaires.
+
Vous devriez avoir identifié le nombre maximal d’adresses IP prises en charge par interface dans la section précédente de cette page.

.. Facultatif : accédez à l’interface de ligne de commande ONTAP pour Cloud Volumes ONTAP et exécutez *network interface show* pour confirmer que chacune de ces adresses IP est utilisée.
+
Si une adresse IP n'est pas utilisée, vous pouvez l'utiliser avec la nouvelle machine virtuelle de stockage.



. De retour dans la console AWS, cliquez sur *Attribuer une nouvelle adresse IP* pour attribuer des adresses IP supplémentaires en fonction de la quantité dont vous avez besoin pour la nouvelle machine virtuelle de stockage.
+
** Système à nœud unique : une adresse IP privée secondaire inutilisée est requise.
+
Une adresse IP privée secondaire facultative est requise si vous souhaitez créer un LIF de gestion sur la machine virtuelle de stockage.

** Paire HA dans une seule AZ : une IP privée secondaire inutilisée est requise sur le nœud 1.
+
Une adresse IP privée secondaire facultative est requise si vous souhaitez créer un LIF de gestion sur la machine virtuelle de stockage.

** Paire HA dans plusieurs AZ : une IP privée secondaire inutilisée est requise sur chaque nœud.


. Si vous allouez l'adresse IP sur une paire HA dans une seule zone de disponibilité, activez *Autoriser la réattribution des adresses IPv4 privées secondaires*.
. Cliquez sur *Enregistrer*.
. Si vous avez une paire HA dans plusieurs AZ, vous devrez répéter ces étapes pour le nœud 2.




== Créer une machine virtuelle de stockage sur un système à nœud unique

Ces étapes créent une nouvelle machine virtuelle de stockage sur un système à nœud unique.  Une adresse IP privée est requise pour créer un NAS LIF et une autre adresse IP privée facultative est nécessaire si vous souhaitez créer un LIF de gestion.

.Étapes
. Créez la machine virtuelle de stockage et un itinéraire vers la machine virtuelle de stockage.
+
[source, cli]
----
vserver create -rootvolume-security-style unix -rootvolume root_svm_2 -snapshot-policy default -vserver svm_2 -aggregate aggr1
----
+
[source, cli]
----
network route create -destination 0.0.0.0/0 -vserver svm_2 -gateway subnet_gateway
----
. Créer un NAS LIF.
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-data-files -home-port e0a -address private_ip_x -netmask node1Mask -lif ip_nas_2 -home-node cvo-node
----
+
Où _private_ip_x_ est une IP privée secondaire inutilisée sur e0a.

. Facultatif : créez un LIF de gestion de machine virtuelle de stockage.
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-management -home-port e0a -address private_ip_y -netmask node1Mask -lif ip_svm_mgmt_2 -home-node cvo-node
----
+
Où _private_ip_y_ est une autre IP privée secondaire inutilisée sur e0a.

. Affectez un ou plusieurs agrégats à la machine virtuelle de stockage.
+
[source, cli]
----
vserver add-aggregates -vserver svm_2 -aggregates aggr1,aggr2
----
+
Cette étape est nécessaire car la nouvelle machine virtuelle de stockage doit accéder à au moins un agrégat avant de pouvoir créer des volumes sur la machine virtuelle de stockage.





== Créer une machine virtuelle de stockage sur une paire HA dans une seule zone de disponibilité

Ces étapes créent une nouvelle machine virtuelle de stockage sur une paire HA dans une seule zone de disponibilité.  Une adresse IP privée est requise pour créer un NAS LIF et une autre adresse IP privée facultative est nécessaire si vous souhaitez créer un LIF de gestion.

Ces deux LIF sont alloués sur le nœud 1.  Les adresses IP privées peuvent se déplacer entre les nœuds en cas de panne.

.Étapes
. Créez la machine virtuelle de stockage et un itinéraire vers la machine virtuelle de stockage.
+
[source, cli]
----
vserver create -rootvolume-security-style unix -rootvolume root_svm_2 -snapshot-policy default -vserver svm_2 -aggregate aggr1
----
+
[source, cli]
----
network route create -destination 0.0.0.0/0 -vserver svm_2 -gateway subnet_gateway
----
. Créez un NAS LIF sur le nœud 1.
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-data-files -home-port e0a -address private_ip_x -netmask node1Mask -lif ip_nas_2 -home-node cvo-node1
----
+
Où _private_ip_x_ est une IP privée secondaire inutilisée sur e0a de cvo-node1.  Cette adresse IP peut être déplacée vers l'e0a de cvo-node2 en cas de prise de contrôle car la politique de service default-data-files indique que les IP peuvent migrer vers le nœud partenaire.

. Facultatif : créez un LIF de gestion de machine virtuelle de stockage sur le nœud 1.
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-management -home-port e0a -address private_ip_y -netmask node1Mask -lif ip_svm_mgmt_2 -home-node cvo-node1
----
+
Où _private_ip_y_ est une autre IP privée secondaire inutilisée sur e0a.

. Affectez un ou plusieurs agrégats à la machine virtuelle de stockage.
+
[source, cli]
----
vserver add-aggregates -vserver svm_2 -aggregates aggr1,aggr2
----
+
Cette étape est nécessaire car la nouvelle machine virtuelle de stockage doit accéder à au moins un agrégat avant de pouvoir créer des volumes sur la machine virtuelle de stockage.

. Si vous exécutez Cloud Volumes ONTAP 9.11.1 ou une version ultérieure, modifiez les stratégies de service réseau pour la machine virtuelle de stockage.
+
La modification des services est nécessaire car elle garantit que Cloud Volumes ONTAP peut utiliser le LIF iSCSI pour les connexions de gestion sortantes.

+
[source, cli]
----
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service data-fpolicy-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-ad-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-dns-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-ldap-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-nis-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service data-fpolicy-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-ad-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-dns-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-ldap-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-nis-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service data-fpolicy-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-ad-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-dns-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-ldap-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-nis-client
----




== Créer une machine virtuelle de stockage sur une paire HA dans plusieurs AZ

Ces étapes créent une nouvelle machine virtuelle de stockage sur une paire HA dans plusieurs AZ.

Une adresse IP _flottante_ est requise pour un NAS LIF et est facultative pour un LIF de gestion.  Ces adresses IP flottantes ne nécessitent pas que vous allouiez des adresses IP privées dans AWS.  Au lieu de cela, les adresses IP flottantes sont automatiquement configurées dans la table de routage AWS pour pointer vers l'ENI d'un nœud spécifique dans le même VPC.

Pour que les adresses IP flottantes fonctionnent avec ONTAP, une adresse IP privée doit être configurée sur chaque machine virtuelle de stockage sur chaque nœud.  Cela se reflète dans les étapes ci-dessous où un LIF iSCSI est créé sur le nœud 1 et sur le nœud 2.

.Étapes
. Créez la machine virtuelle de stockage et un itinéraire vers la machine virtuelle de stockage.
+
[source, cli]
----
vserver create -rootvolume-security-style unix -rootvolume root_svm_2 -snapshot-policy default -vserver svm_2 -aggregate aggr1
----
+
[source, cli]
----
network route create -destination 0.0.0.0/0 -vserver svm_2 -gateway subnet_gateway
----
. Créez un NAS LIF sur le nœud 1.
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-data-files -home-port e0a -address floating_ip -netmask node1Mask -lif ip_nas_floating_2 -home-node cvo-node1
----
+
** L'adresse IP flottante doit être en dehors des blocs CIDR pour tous les VPC de la région AWS dans laquelle vous déployez la configuration HA.  192.168.209.27 est un exemple d'adresse IP flottante. link:reference-networking-aws.html#requirements-for-ha-pairs-in-multiple-azs["En savoir plus sur le choix d'une adresse IP flottante"] .
** `-service-policy default-data-files`indique que les IP peuvent migrer vers le nœud partenaire.


. Facultatif : créez un LIF de gestion de machine virtuelle de stockage sur le nœud 1.
+
[source, cli]
----
network interface create -auto-revert true -vserver svm_2 -service-policy default-management -home-port e0a -address floating_ip -netmask node1Mask -lif ip_svm_mgmt_2 -home-node cvo-node1
----
. Créez un LIF iSCSI sur le nœud 1.
+
[source, cli]
----
network interface create -vserver svm_2 -service-policy default-data-blocks -home-port e0a -address private_ip -netmask nodei1Mask -lif ip_node1_iscsi_2 -home-node cvo-node1
----
+
** Ce LIF iSCSI est requis pour prendre en charge la migration LIF des IP flottantes dans la machine virtuelle de stockage.  Il n’est pas nécessaire qu’il s’agisse d’un LIF iSCSI, mais il ne peut pas être configuré pour migrer entre les nœuds.
** `-service-policy default-data-block`indique qu'une adresse IP ne migre pas entre les nœuds.
** _private_ip_ est une adresse IP privée secondaire inutilisée sur eth0 (e0a) de cvo_node1.


. Créez un LIF iSCSI sur le nœud 2.
+
[source, cli]
----
network interface create -vserver svm_2 -service-policy default-data-blocks -home-port e0a -address private_ip -netmaskNode2Mask -lif ip_node2_iscsi_2 -home-node cvo-node2
----
+
** Ce LIF iSCSI est requis pour prendre en charge la migration LIF des IP flottantes dans la machine virtuelle de stockage.  Il n’est pas nécessaire qu’il s’agisse d’un LIF iSCSI, mais il ne peut pas être configuré pour migrer entre les nœuds.
** `-service-policy default-data-block`indique qu'une adresse IP ne migre pas entre les nœuds.
** _private_ip_ est une adresse IP privée secondaire inutilisée sur eth0 (e0a) de cvo_node2.


. Affectez un ou plusieurs agrégats à la machine virtuelle de stockage.
+
[source, cli]
----
vserver add-aggregates -vserver svm_2 -aggregates aggr1,aggr2
----
+
Cette étape est nécessaire car la nouvelle machine virtuelle de stockage doit accéder à au moins un agrégat avant de pouvoir créer des volumes sur la machine virtuelle de stockage.

. Si vous exécutez Cloud Volumes ONTAP 9.11.1 ou une version ultérieure, modifiez les stratégies de service réseau pour la machine virtuelle de stockage.
+
La modification des services est nécessaire car elle garantit que Cloud Volumes ONTAP peut utiliser le LIF iSCSI pour les connexions de gestion sortantes.

+
[source, cli]
----
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service data-fpolicy-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-ad-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-dns-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-ldap-client
network interface service-policy remove-service -vserver <svm-name> -policy default-data-files -service management-nis-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service data-fpolicy-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-ad-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-dns-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-ldap-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-blocks -service management-nis-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service data-fpolicy-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-ad-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-dns-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-ldap-client
network interface service-policy add-service -vserver <svm-name> -policy default-data-iscsi -service management-nis-client
----

